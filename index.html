<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resident Performance & Safety Calculator</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f4f7f9;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .container {
            width: 100%;
            max-width: 800px;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header {
            background-color: #003366;
            color: white;
            padding: 25px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 1.8em;
        }
        .header p {
            margin: 10px 0 0;
            opacity: 0.9;
            font-size: 0.9em;
        }
        .calculator-body {
            display: flex;
            flex-wrap: wrap;
            padding: 25px;
        }
        .inputs {
            width: 100%;
            padding-bottom: 25px;
            border-bottom: 1px solid #e0e0e0;
            margin-bottom: 25px;
        }
        @media (min-width: 600px) {
            .inputs {
                width: 40%;
                border-bottom: none;
                border-right: 1px solid #e0e0e0;
                padding-right: 25px;
                margin-bottom: 0;
            }
        }
        .outputs {
            width: 100%;
        }
        @media (min-width: 600px) {
            .outputs {
                width: 60%;
                padding-left: 25px;
            }
        }
        .input-group {
            margin-bottom: 20px;
        }
        .input-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #555;
        }
        .input-group input, .input-group select {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            font-size: 1em;
            box-sizing: border-box;
        }
        .output-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        .output-card {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }
        .output-card h3 {
            margin: 0 0 10px;
            font-size: 1em;
            color: #003366;
        }
        .output-value {
            font-size: 2.2em;
            font-weight: 700;
            color: #0056b3;
        }
        .output-unit {
            font-size: 0.8em;
            color: #6c757d;
        }
        .equivalence-card {
            grid-column: 1 / -1;
            background-color: #fffbe6;
            border-color: #ffe58f;
            color: #664d03;
        }
        .equivalence-value {
            font-size: 1.1em;
            font-weight: 600;
        }
        .footer {
            background-color: #e9ecef;
            padding: 15px;
            text-align: center;
            font-size: 0.8em;
            color: #6c757d;
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="header">
            <h1>Resident Performance & Safety Calculator</h1>
            <p>An interactive tool based on a simulation model of medical provider performance under varying levels of sleep deprivation.</p>
        </div>
        <div class="calculator-body">
            <div class="inputs">
                <h2>Your Inputs</h2>
                <div class="input-group">
                    <label for="sleepHours">Hours of Sleep Tonight</label>
                    <input type="number" id="sleepHours" value="5.5" min="0" max="10" step="0.5" oninput="calculatePerformance()">
                </div>
                <div class="input-group">
                    <label for="experience">Experience Level</label>
                    <select id="experience" onchange="calculatePerformance()">
                        <option value="1">Student</option>
                        <option value="2" selected>Resident</option>
                        <option value="3">Attending</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="specialty">Specialty</label>
                    <select id="specialty" onchange="calculatePerformance()">
                        <option value="1">Emergency Medicine</option>
                        <option value="2">Surgery</option>
                        <option value="3" selected>Internal Medicine</option>
                        <option value="4">Anesthesiology</option>
                        <option value="5">ICU</option>
                        <option value="6">Other</option>
                    </select>
                </div>
            </div>
            <div class="outputs">
                <h2>Predicted Performance</h2>
                <div class="output-grid">
                    <div class="output-card">
                        <h3>Clinical Skill Score</h3>
                        <span class="output-value" id="clinicalScoreOutput">84.6</span>
                        <span class="output-unit">/ 100</span>
                    </div>
                    <div class="output-card">
                        <h3>Reaction Time</h3>
                        <span class="output-value" id="reactionTimeOutput">334</span>
                        <span class="output-unit">ms</span>
                    </div>
                    <div class="output-card">
                        <h3>Medical Error Risk</h3>
                        <span class="output-value" id="errorRiskOutput">+37</span>
                        <span class="output-unit">% increase in odds</span>
                    </div>
                    <div class="output-card">
                        <h3>Attentional Lapses</h3>
                        <span class="output-value" id="lapsesOutput">5.5</span>
                        <span class="output-unit">expected count</span>
                    </div>
                    <div class="output-card equivalence-card">
                        <h3>Cognitive State Equivalent</h3>
                        <span class="equivalence-value" id="equivalenceOutput">Comparable to a Blood Alcohol Concentration of ~0.05%</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="footer">
            <p>Disclaimer: This is a simulation model for educational and illustrative purposes. It is based on a synthetic dataset derived from a synthesis of published literature and is not intended for clinical decision-making.</p>
        </div>
    </div>

    <script>
        // --- Regression Coefficients Extracted from Stata Output ---

        const models = {
            clinicalScore: {
                intercept: 62.56478,
                sleep_hours: 3.959471,
                specialty: { '2': -1.356712, '3': 0.5642855, '4': -0.5058796, '5': -0.8988267, '6': -1.149943 },
                experience: { '2': -0.061165, '3': 1.695696 }
            },
            reactionTime: {
                intercept: 265.0721,
                sleep_debt: 44.15841,
                specialty: { '2': -3.434337, '3': 4.217632, '4': -4.396422, '5': 8.38903, '6': -2.946512 },
                experience: { '2': 5.045554, '3': -7.005645 }
            },
            medicalError: { // These are log-odds coefficients
                intercept: -2.95115, // ln(0.0522753)
                sleep_debt: 0.20119, // ln(1.22285)
                specialty: { '2': 0.3689, '3': 0.3111, '4': 0.4970, '5': -0.8288, '6': 0.8796 },
                experience: { '2': -0.2056, '3': -0.3463 }
            },
            attentionalLapses: { // These are log-rate coefficients
                intercept: -0.3101, // ln(0.7334348)
                sleep_debt: 0.4624327,
                specialty: { '2': 0.0885, '3': 0.0129, '4': 0.0525, '5': 0.0048, '6': 0.0633 },
                experience: { '2': 0.0090, '3': -0.0005 }
            }
        };

        function calculatePerformance() {
            // --- 1. Get User Inputs ---
            const sleepHours = parseFloat(document.getElementById('sleepHours').value);
            const experience = document.getElementById('experience').value;
            const specialty = document.getElementById('specialty').value;
            
            // Calculate sleep debt (assuming 7-hour baseline)
            const sleepDebt = Math.max(0, 7 - sleepHours);

            // --- 2. Perform Calculations for each Metric ---

            // Clinical Score
            let score = models.clinicalScore.intercept;
            score += models.clinicalScore.sleep_hours * sleepHours;
            score += models.clinicalScore.specialty[specialty] || 0; // Add specialty effect if it exists
            score += models.clinicalScore.experience[experience] || 0; // Add experience effect if it exists
            score = Math.max(50, Math.min(100, score)); // Clamp between 50 and 100

            // Reaction Time
            let rt = models.reactionTime.intercept;
            rt += models.reactionTime.sleep_debt * sleepDebt;
            rt += models.reactionTime.specialty[specialty] || 0;
            rt += models.reactionTime.experience[experience] || 0;

            // Medical Error (Odds Ratio)
            let logOdds = models.medicalError.intercept;
            logOdds += models.medicalError.sleep_debt * sleepDebt;
            logOdds += models.medicalError.specialty[specialty] || 0;
            logOdds += models.medicalError.experience[experience] || 0;
            const errorOddsRatio = Math.exp(logOdds);
            const baselineErrorOdds = Math.exp(models.medicalError.intercept);
            const errorIncrease = ((errorOddsRatio / baselineErrorOdds) - 1) * 100;

            // Attentional Lapses (Expected Count)
            let logRate = models.attentionalLapses.intercept;
            logRate += models.attentionalLapses.sleep_debt * sleepDebt;
            logRate += models.attentionalLapses.specialty[specialty] || 0;
            logRate += models.attentionalLapses.experience[experience] || 0;
            const lapses = Math.exp(logRate);
            
            // BAC Equivalence
            let equivalenceText = "Comparable to a rested state.";
            if (sleepHours <= 5) {
                equivalenceText = "Comparable to a Blood Alcohol Concentration of ~0.05%";
            }
            if (sleepHours <= 4) {
                equivalenceText = "Comparable to a Blood Alcohol Concentration of ~0.08% (Legally Impaired)";
            }
            if (sleepHours <= 2) {
                equivalenceText = "Comparable to a Blood Alcohol Concentration of >0.10%";
            }


            // --- 3. Update the Display ---
            document.getElementById('clinicalScoreOutput').innerText = score.toFixed(1);
            document.getElementById('reactionTimeOutput').innerText = rt.toFixed(0);
            document.getElementById('errorRiskOutput').innerText = "+" + errorIncrease.toFixed(0);
            document.getElementById('lapsesOutput').innerText = lapses.toFixed(1);
            document.getElementById('equivalenceOutput').innerText = equivalenceText;
        }

        // Initial calculation on page load
        window.onload = calculatePerformance;

    </script>
</body>
</html>
